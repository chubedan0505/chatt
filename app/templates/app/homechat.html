{% extends 'app/base.html' %}
{% load static %}

{% block main-content1 %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link href="{% static 'appStatic/css/style.css'%}" rel="stylesheet"/>
    <link href="{% static 'appStatic/css/chat.css'%}" rel="stylesheet"/>
    <link href="{% static 'appStatic/css/owl.carousel.min.css'%}" rel="stylesheet"/>
    <link href="{% static 'appStatic/css/min.css'%}" rel="stylesheet"/>
    <link href="{% static 'appStatic/css/main.css'%}" rel="stylesheet"/>
    <link href="{% static 'appStatic/css/chatpage.css'%}" rel="stylesheet"/>
    <link href="{% static 'appStatic/css/chatpage.css'%}" rel="stylesheet"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
<style>
    .img-account-profile {
        object-fit: cover;
        width: 60px;
        height: 60px;
    }

    .msg_card_body {
        position: relative;
        overflow: auto;
        height: 1000px;
        width: 100%;
    }
</style>

<div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
        <div class="col-md-4 col-xl-3 chat">
            <div class="card mb-sm-2 mb-md-0 contacts_card">
                <div class="card-header">
                    <div class="input-group">
                        <input type="text" placeholder="Search..." name="" style="height:20px;" class="form-control search">
                        <div class="input-group-prepend">
                            <span class="input-group-text search_btn"><i class="fas fa-search"></i></span>
                        </div>
                    </div>
                </div>
                <div  class="card-body contacts_body">
                    <ul class="contacts">
                        {% for profilel in profiles %}
                        <li class="" style="height:80px; margin-bottom:0px;" data-username="{{ profilel.user.username }}">
                            <div class="d-flex bd-highlight">
                                <div class="img_cont">
                                    <img src="{{ profilel.image.url }}" class="rounded-circle user_img img-account-profile mt-1 ">
                                    <span class="online_icon mt-"></span>
                                </div>
                                <div class="user_info">
                                    <span class="user-link">{{ profilel.user.username }}</span>
                                    <p>Kalid is online</p>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="card-footer"></div>
            </div>
        </div>

       
        <div class="col-md-10 col-xl-8 chat" style="margin-top:30px;">
            <div class="card">
                <div class="card-header msg_head"  style="height: 70px;">
                    <div class="d-flex bd-highlight">
                        <div class="img_cont" style="height: 50px;">
                             {% if profile %}{% if profile.image %}
                            <img class="img-account-profile rounded-circle mb-2" src="{{ profile.image.url }}"
                                alt="Profile Image" style="width: 50px; height: 50px;">
                            {% else %}
                            <img class="img-account-profile rounded-circle mb-2"
                                src="{% static 'appStatic/images/avt.png' %}" alt="Default Image"
                                style="width: 50px; height: 60px;">
                            {% endif %}
                            {% endif %}
                            <span class="online_icon"></span>
                        </div>
                        <div class="user1_info h5" id="user-info">
                            <span>
                                {% if profile.last_name or profile.first_name %}
                                    {% if profile.last_name %}
                                        {{ profile.last_name }}
                                    {% endif %}
                                    {% if profile.first_name %}
                                        {{ profile.first_name }}
                                    {% endif %}
                                {% else %}
                                    {{ user.username }}
                                {% endif %}
                            </span>
                            <p style="font-size:15px;">Đang Hoạt Động</p>
                        </div>
                        <div class="video_cam">
                            <span><i class="fas fa-video"></i></span>
                            <span><i class="fas fa-phone"></i></span>
                        </div>
                    </div>
                    <span id="action_menu_btn"><i class="fas fa-ellipsis-v"></i></span>
                    <div class="action_menu">
                        <ul>
                            <li><i class="fas fa-user-circle"></i> View profile</li>
                            <li><i class="fas fa-users"></i> Add to close friends</li>
                            <li><i class="fas fa-plus"></i> Add to group</li>
                            <li><i class="fas fa-ban"></i> Block</li>
                        </ul>
                    </div>
                </div>
                <div class="msg_card_body message-container" id="message-container">

                </div>
                <div class="chat-message clearfix mb-0">
                    <div class="input-group mb-0">
                        <textarea style="height:30px;" name=""  class="form-control type_msg" id="id_message_send_input" placeholder="Nhập tin nhắn..."></textarea>
                        <button type="submit"  id="id_message_send_button" class="input-group-text send_btn" ><i class="fas fa-location-arrow"></i></button>
                    </div>
                </div>
            </div>
        </div>
       
    </div>
</div>

<script>
    $(document).ready(function(){
        // Đọc lịch sử tin nhắn từ CSDL và hiển thị khi tải lại trang
        $.ajax({
            url: '/get_chat_history/',  // Đường dẫn đến view Django xử lý lấy lịch sử tin nhắn từ CSDL
            method: 'GET',
            success: function (data) {
                displayChatHistory(data.messages);
            },
            error: function (error) {
                console.log('Error:', error);
            }
        });

        // Kết nối WebSocket và xử lý tin nhắn mới
        const chatSocket = new WebSocket('ws://' + window.location.host + '/');

        chatSocket.onopen = function (e) {
            console.log('The connection was set up successfully!');
        };

        chatSocket.onclose = function (e) {
            console.log('Something unexpected happened!');
        };

        document.querySelector('#id_message_send_input').focus();

        document.querySelector('#id_message_send_input').onkeyup = function (e) {
            if (e.keyCode == 13) {
                document.querySelector('#id_message_send_button').click();
            }
        };

        document.querySelector('#id_message_send_button').onclick = function (e) {
            var messageInput = document.querySelector('#id_message_send_input').value;
            chatSocket.send(JSON.stringify({ message: messageInput, username: '{{request.user.username}}' }));
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            var div = document.createElement('div');
            document.querySelector('#id_message_send_input').value = '';

            // Kiểm tra xem người gửi có phải là người hiện tại không
            const isSender = data.username == '{{request.user.username}}';

            if (isSender) {
                div.className = 'msg_cotainer_send';
            } else {
                div.className = 'msg_cotainer';
            }

            div.innerHTML = data.message;
            document.querySelector('.msg_card_body').appendChild(div);

            // Lưu tin nhắn vào CSDL thông qua AJAX
            saveMessageToDatabase({ message: data.message, username: data.username, isSender: isSender });
            // Cuộn xuống dưới cùng để xem tin nhắn mới nhất
            scrollToBottom();
        };

        function saveMessageToDatabase(messageData) {
            $.ajax({
                url: '/save_message/',  // Đường dẫn đến view Django xử lý lưu tin nhắn vào CSDL
                method: 'POST',
                data: {
                    'message': messageData.message,
                    'username': messageData.username,
                    'is_sender': messageData.isSender,
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                },
                success: function (data) {
                    // Xử lý thành công (nếu cần)
                    displayChatHistory(data.messages);
                },
                error: function (error) {
                    console.log('Error:', error);
                }
            });
        }

        function displayChatHistory(messages) {
            const msgContainer = document.querySelector('.msg_card_body');

            messages.forEach(messageData => {
                const messageDiv = document.createElement('div');

                if (messageData.isSender) {
                    messageDiv.className = 'msg_cotainer_send';
                } else {
                    messageDiv.className = 'msg_cotainer';
                }

                messageDiv.innerHTML = messageData.message;
                msgContainer.appendChild(messageDiv);
            });

            // Cuộn xuống dưới cùng để xem tin nhắn mới nhất
            scrollToBottom();
        }

        function scrollToBottom() {
            const msgContainer = document.querySelector('.msg_card_body');
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }
    });
    


    document.querySelectorAll('.contacts_body .contacts li').forEach(function (element) {
        element.addEventListener('click', function () {
            // Đọc data-attributes từ phần tử <li>
            var username = this.getAttribute('data-username');

            // Hiển thị thông tin user trong phần hiển thị thông tin
            var userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `
                <span>${username}</span>
                <p style="font-size:15px;">Đang Hoạt Động</p>
            `;
        });
    });

</script>

</body>
</html>
{% endblock main-content1 %}
